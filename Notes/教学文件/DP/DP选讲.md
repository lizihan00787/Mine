[TOC]



# DP选讲

## P2517 [HAOI2010] 订货

某公司估计市场在第 $i$ 个月对某产品的需求量为 $U_i$，已知在第 $i$ 月该产品的订货单价为 $d_i$，上个月月底未销完的单位产品要付存贮费用 $m$，假定第一月月初的库存量为 $0$，第 $n$ 月月底的库存量也为 $0$，问如何安排这 $n$ 个月订购计划，才能使成本最低？每月月初订购，订购后产品立即到货，进库并供应市场，于当月被售掉则不必付存贮费。假设仓库容量为 $S$。

第 $1$ 行：$n, m, S \ (0\le n\le50, 0\le m\le10, 0\le S\le10000)$。

第 $2$ 行：$U_1 , U_2 , \cdots , U_n \ (0\le U_i\le10000)$。

第 $3$ 行：$d_1, d_2, \cdots ,d_n \ (0\le d_i\le100)$。



















## Sol

有几种做法。

费用流略。

令 $f_{i,j}$ 为第 $i$ 个月卖完之后还有 $j$ 个的最小花费。

如果 $i-1$ 个月 卖完后还有 $k$ 个，第 $i$ 个月买了 $j+U_{i}-k$ 个。

方程：$f_{i,j}=\min ( f_{i-1,k}+ (j+U_i-k)\times D_{i}+ k\times m)$ ，复杂度 $O(nS^2)$

复杂度主要来源于 $S$ 对 $S$ 的枚举。

开始优化 化柿子。

$f_{i,j}=\min ( f_{i-1,k} -k\times D_{i}+ k\times m)+(j+U_i)\times D_i$

$min$ 的部分前缀优化即可。





## P3158 [CQOI2011] 放棋子

在一个 $m$ 行 $n$ 列的棋盘里放一些彩色的棋子，使得每个格子最多放一个棋子，且不同颜色的棋子不能在同一行或者同一列，有多少种方法？

$1\le n,m\le 30$，$1\le c\le 10$，总棋子数 $\le \max (250,n\times m)$。















## Sol

看到数据范围先考虑状压，时间压不下来。

注意到不同颜色之间的行列是独立的，令 $f_{i,j,k}$ 表示前 $k$ 种颜色棋子占据 $i$ 行 $j$ 列的方案数。

$f_{i,j,k} = \sum\limits_{l=0}^{i-1}\sum\limits_{r=0}^{j-1}f_{l,r,k-1}\times 用 a[k] 枚棋子占据任意的i行j列的方案数$

考虑计算后面那一块，令 $g_{i,j,k}$ 表示任意 $k$ 枚同色棋子占据 $i$ 行 $j$ 列的方案数。

 $g_{i,j,k}=C_{i\times j}^k-\sum\limits_{l=1}^{i}\sum\limits_{r=0}^{j}g[l][r][k]\times C_i^l \times C_j^r$

左边是$i\times j$ 个格子任意取，右边是没放满 $i,j$ 行列的方案数。



另附一种做法：

令 $f(n,m)=\binom{nm}{k}$  表示 $k$ 个棋子占据至多 $n$ 行 $m$ 列的方案数。

$g(n,m)$ 表示恰好占据这么多的方案数。

$f(n,m)=\sum\sum\binom{n}{i}\binom{m}{j}g(i,j)$

二项式反演一下 $g(n,m)=\sum\sum\binom{n}{i}\binom{m}{j}(-1)^{n-i}(-1)^{m-j}f(i,j)$ 









##P3515 [POI2011] Lightning Conductor  

给定一个长度为 $n$ 的序列 $\{a_n\}$，对于每个 $i\in [1,n]$ ，求出一个最小的非负整数 $p$ ，使得 $\forall j\in[1,n]$，都有 $a_j\le a_i+p-\sqrt{|i-j|}$

$1 \le n \le 5\times 10^{5}$，$0 \le a_i \le 10^{9}$ 。

















## Sol

$p>= max(a_j+\sqrt{|i-j|}）-a_i$

拆绝对值决策单调性正做一次反做一次。

求的是最大值。



四边形不等式实际上描述了一个三维凸包，任意一个x(y) 的 对应决策点 y(x) 在三维凸包上是单增的。

直接对应的问题是 $f_j \leftarrow  w(i,j)(i\leq j)$。能用反证法证明 $f_i$ 满足决策单调性。

对一般性问题 $f_j\leftarrow f_i+w(i,j)(i\leq j)$ 相同证法。

注意求最大和最小值不等式的符号相反，称为反四边形不等式。



一般两种问题：区间合并和区间拆分

区间合并见p1880合并石子，你谷第一篇题解就是这个，不证了

区间拆分如上述一般性问题。



有两种做法，分治和二分队列。二分队列是半在线





## P5574 [CmdOI2019] 任务分配问题

在某台有 $k$ 个 CPU 的计算机中，有 $n$ 个计算任务等待执行。

$a_i$ 为第 $i$ 个任务的优先级，方便起见， $a$ 为一个排列。

现在，要将这些任务分配给 CPU 去解决。

由于内存等原因，一个 CPU 只能负责连续一段的任务，并且要按 (从左到右的) 顺序执行。

**在某个 CPU 内**，无序度定义为：前者先执行，而后者优先级高的任务对的个数。

请最小化每个 CPU 的无序度之和。



对于所有测试数据，保证 $1\leq n\leq 2.5\times 10^4$，$1\leq k\leq 25$，$k\leq n$。













## Sol

决策单调性。

注意每次没必要重新算某个区间的贡献，可以类莫队由上一次算的推过来。





## P5504 [JSOI2011] 柠檬

$\text{Flute}$ 很喜欢柠檬。它准备了一串用树枝串起来的贝壳，打算用一种魔法把贝壳变成柠檬。贝壳一共有 $n$ $(1≤n≤100000)$ 只，按顺序串在树枝上。为了方便，我们从左到右给贝壳编号 $1..n$ 。每只贝壳的大小不一定相同，贝壳 $i$ 的大小为 $s_i(1≤s_i≤10000)$ 。

变柠檬的魔法要求$:\ \text{Flute}$ 每次从树枝一端取下一小段连续的贝壳，并选择一种贝壳的大小 $s_0$。如果这一小段贝壳中大小为 $s_0$ 的贝壳有 $t$ 只，那么魔法可以把这一小段贝壳变成 $s_0t^2$ 只柠檬。$\text{Flute}$ 可以取任意多次贝壳，直到树枝上的贝壳被全部取完。各个小段中，$\text{Flute}$ 选择的贝壳大小 $s_0$ 可以不同。而最终 $\text{Flute}$ 得到的柠檬数，就是所有小段柠檬数的总和。

$\text{Flute}$ 想知道，它最多能用这一串贝壳变出多少柠檬。请你帮忙解决这个问题。最后一只贝壳，通过魔法可以得到 $3×1^2 = 3$ 只柠檬。总共可以得到 $18+3=21$ 只柠檬。没有比这更优的方案了。











## Sol

略







## P4383 [八省联考 2018] 林克卡特树

小 L 最近沉迷于塞尔达传说：荒野之息（The Legend of Zelda: Breath of The Wild）无法自拔，他尤其喜欢游戏中的迷你挑战。

游戏中有一个叫做 LCT 的挑战，它的规则是这样子的：现在有一个 $N$ 个点的树，每条边有一个整数边权 $v_i$，若 $v_i \geq 0$，表示走这条边会获得 $v_i$ 的收益；若 $v_i \lt 0$ ，则表示走这条边需要支付 $-v_i$ 的过路费。小 L 需要控制主角 Link 切掉（Cut）树上的恰好 $K$ 条边，然后再连接 $K$ 条边权为 0 的边，得到一棵新的树。接着，他会选择树上的两个点 $p,q$，并沿着树上连接这两点的简单路径从 $p$ 走到 $q$，并为经过的每条边支付过路费/ 获取相应收益。

海拉鲁大陆之神 TemporaryDO 想考验一下 Link。他告诉 Link，如果 Link 能切掉合适的边、选择合适的路径从而使 总收益 - 总过路费 最大化的话，就把传说中的大师之剑送给他。

小 L 想得到大师之剑，于是他找到了你来帮忙，请你告诉他，Link 能得到的 总收益 - 总过路费 最大是多少。

对于全部的测试数据，保证 $1 \leq N \leq 3 \times 10^5$，$0 \leq K \leq 3 \times 10^5$，$K \lt N$，$1 \leq x_i,y_i \leq N$，$|v_i| \leq 10^6$。









## Sol

略









## P6246 [IOI 2000] 邮局 加强版 加强版

高速公路旁边有 $n$ 个村庄。高速公路表示为整数轴，每个村庄的位置用单个整数坐标标识。两个位置之间的距离是其整数坐标差的绝对值。

现在要建立  $m$ 个邮局，邮局将建在一些，但不一定是所有的村庄中。为了建立邮局，应选择他们建造的位置，使每个村庄与其最近的邮局之间的距离总和最小。

你要编写一个程序，已知村庄的位置和邮局的数量，计算每个村庄和最近的邮局之间所有距离的最小可能的总和。



对于全部的测试点，保证 $1 \leq m \leq n \leq 5 \times 10^5$，$0 \leq a_i \leq 2\times 10^6$，且 $a_i$ 的值在对应范围内均匀随机。

$n\leq 10^3$ 怎么做?













## Sol

本题为带区间个数限制的决策单调性DP。

对于所有的个数限制，都能求出一个答案且随个数限制增加而增加。

原本的 $dp $ 是令 $f_{i,j}$ 为前 $i$ 个村庄有 $j$ 个邮局。现在可以把 $j$ 一维去掉用 $wqs$ 二分解决恰好 $m$ 个邮局的限制。







##P4463 [集训队互测 2012] calc

一个序列 $a_1,a_2,\dots,a_n$ 是合法的，当且仅当：

- $a_1,a_2,\dots,a_n$ 都是 $[1,k]$ 中的整数。
- $a_1,a_2,\dots,a_n$ 互不相等。

一个序列的值定义为它里面所有数的乘积，即 $a_1\times a_2\times\dots\times a_n$。

求所有不同合法序列的值的和对 $p$ 取模后的结果。两个序列不同当且仅当他们任意一位不同。



对于 $100\%$ 的数据，$k \le 10 ^ 9$，$n \le 500$，$p \le 10 ^ 9$，保证 $p$ 为素数，保证 $n + 1 < k < p$。









## Sol

令 $f(i,j)$ 为前 $i$ 个数值域取 $[i,j]$ 的所有不同序列的值的和，先只考虑递增的序列，最后乘个 $n!$

易知 $f(i,j)=f(i-1,j-1)*j+f(i,j-1)$，答案为 $f(n,A)\times n!$

复杂度 $O(nA)$

看到上述递推式，可以联想到常系数齐次线性递推的相似形式，答案一定是一个多项式。

假设 $f(n,i)$ 是关于 $i$ 的 $g(n)$ 次多项式。

容易证明若 $p(x)$ 是 $n$ 次多项式，则 $p(x)-p(x-1)$ 是 $n-1$ 次多项式。

上式 $f(i,j)-f(i,j-1)=f(n-1,i-1)\times i$ ，左边是关于 $i$ 的 $g(n)-1$ 次多项式，右边是关于 $i$

 的 $g(n-1)+1$ 次多项式。可得 $g(n)=2n$。

求出2n个点后插值即可。 



另：上面多项式的形式是 $\prod\limits_{i=1}^{A}(1+ix)$，可以用多项式科技优化到 $nlogn$，见p5850。







## P9129 [USACO23FEB] Piling Papers G

农夫约翰在纸片上写下了 $N (1 \le N \le 300)$ 个数字。对于每个 $i \in [1,N]$，第 $i$ 张纸片上写着数字 $a_i (1 \le a_i \le 9)$。

奶牛们有两个最喜欢的整数 $A$ 和 $B(1 \le A \le B<10^{18})$，希望你回答 $Q (1 \le Q \le 5 \times 10^4)$ 个查询。对于第 $i$ 个查询，奶牛们将从左到右移动穿过纸片 $l_i \cdots r_i (1 \le l_i \le r_i \le N)$，保持一个最初为空的纸片堆。对于每张纸片，它们可以选择将其添加到堆的顶部、底部，或者不添加。最后，它们将从顶部到底部读取堆中的纸片，形成一个整数。在奶牛们在此过程中做选择的所有 $3 ^ {r_i-l_i+1}$ 种方式中，计算出结果在 $[A,B]$ 范围内的方式数量，并输出这个数量对 $10^9+7$ 取模的结果。















## Sol

类似数位DP贴上界处理。离线处理。





## CF1159E

求有多少长为 $n$ 的序列满足：

- $l_i\leq a_i\leq r_i$
- $\sum\limits_{i=1}^n a_i\leq m$
- $gcd(a_1,...,a_n)=1$

$n\leq 50,m\leq 10^5$

答案对 998244353 取模。









## Sol

普通背包套了一个互质的限制？

令 $F(x)$ 表示 $gcd(a_1,...,a_k)=x$ 的答案，$G(x)$ 表示 $x|gcd(a_1,...,a_k)$ 的答案。

那么 $F(x)=G(x)-\sum\limits_{d=2}^{ \frac{m}{x} }F(dx)$

$G(x)$ 可以背包求，$F(x)$ 可以从大到小求出。

由于有 $ \frac{m}{x}$ 可以缩小背包规模，时间复杂度为调和级数级别。





## CF1174E Ehab and the Expected GCD Problem

对于排列 $p$ ，定义 $f(p):$设 $g_i$ 为 $p_1,p_2,...,p_i$ 的最大公因数，$f(p)$ 为 $g(1),g(2),...,g(n)$ 中不同的数的个数。

设 $f_{max}(n)$ 为 $1,2,...,n$ 所有排列中 $f(p)$ 的最值，问有多少种排列满足 $f(p)=f_{max}(n)$。

答案对 $10^9+7$ 取模。









## Sol

容易证明第一个数只有可能是 $2^x\times 3^y(y\leq 1)$ 的形式。

令 $f[i][x][y]$ 表示前 $i$ 个数，$gcd$ 为 $2^x\times 3^x$ 的方案数。

转移如下：

令 $cnt(x)=\frac{n}{x}$

- gcd不变：$f[i][x][y]+=f[i-1][x][y](cnt(2^x\times 3^y)-(i-1))$。前 $i-1$ 个数都是 $i$ 的倍数。
- gcd/2:$f[i][x][y]+=f[i-1][x+1][y](cnt(2^x\times 3^y)-cnt(2^{x+1}\times 3^y))$
- gcd/3:$f[i][x][y]+=f[i-1][x][y+1](cnt(2^x\times 3^y)-cnt(2^{x}\times 3^{y+1}))$

时间复杂度 $nlogn$。







## CF1574F

定义 a 的子序列是 [al,al+1,⋯,ar] 的连续子段构成的序列，定义 a 序列在 b 序列中出现的次数为 b 序列中与 a 相同的子序列个数。

有 n 个值域在 [1,k] 的数列 A1,A2,⋯,An，要求构造一个长为 m 的值域在 [1,k] 的序列 a，满足对于所有数列 Ai，Ai 在序列 a 中的出现次数大于等于其任意一个非空子序列在 a 中的出现次数。

求不同的 a 的数量，答案 mod998244353。

**数据范围**：1≤n,m,k≤3×105,∑ci≤3×105。









## Sol

按序列建图，易知只有链能满足条件。

链长最多根号个，总复杂度带个根号跑背包。





## AT_abc262_h [ABC262Ex] Max Limited Sequence

求满足以下条件的长度为 $N$ 的序列 $A=(A_1,A_2,\cdots A_N)$ 有多少种：
+ $\forall i \in[1,N],0\leq A_i\leq M$
+ $\forall i \in[1,Q],\max \limits_{L_i\leq j\leq R_i}A_j=X_i$

$1\leq N\leq 2\times 10^5$

$1\leq M<998244353$

$1\leq Q\leq 2\times 10^5$

$\forall i \in [1,Q],1\leq L_i\leq R_i\leq N,1\leq X_i\leq M$







## Sol

题目转化为有 $m$ 个区间限制，每个区间内部至少一个点为 1 。

令 $f_{i,j}$ 为 在 $i$ 之前的区间都满足，最后一个为 $1$ 的位置是 $j$ 的方案数。

把 $i$ 滚掉，转移有三种：

- $f_{i-1,j} \rightarrow f_{i,i}$ 表示 $i$ 位置为 1
- $f_{i-1,j}\times x \rightarrow f_{i,j}$ 表示位置 $i$ 为0
- 对限制 $[l,i]$,将所有 $f_{i,j}(j<l)$赋值为0

用线段树操作。





选做：

cf1542e2

p9151

p10879





